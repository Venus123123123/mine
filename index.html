<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финальный Чат с Игрой</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --text-color: #f0f0f0; --accent-color: #0084ff; --glass-bg: rgba(0, 0, 0, 0.4);
            --glass-border: rgba(255, 255, 255, 0.2); --shadow-color: rgba(0, 0, 0, 0.37);
            --danger-color: #e74c3c;
            --rarity-common: #9e9e9e; --rarity-rare: #64b5f6; --rarity-epic: #ba68c8; --rarity-legendary: #ffd54f;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', sans-serif; color: var(--text-color); margin: 0;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden;
        }
        #background-animation {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            background: linear-gradient(-45deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%; animation: gradientAnimation 15s ease infinite;
        }
        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .glass-container {
            width: 100%; max-width: 500px; padding: 30px; background: var(--glass-bg);
            border-radius: 16px; box-shadow: 0 8px 32px 0 var(--shadow-color);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); transition: transform 0.1s ease-in-out;
        }
        .page { display: none; }
        .page.active { display: block; }
        h2 { text-align: center; margin-bottom: 25px; font-weight: 600; }
        input { width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-color); font-family: 'Montserrat', sans-serif; font-size: 1em; }
        .btn { display: block; width: 100%; padding: 14px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; text-align: center; text-decoration: none; font-size: 1em; font-weight: 600; transition: all 0.2s ease; }
        .link { color: var(--accent-color); text-decoration: none; cursor: pointer; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; }
        .header-icons a { font-size: 1.5em; text-decoration: none; margin-left: 15px; }
        
        #chat-window { height: 450px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding: 10px; margin-bottom: 15px; border-radius: 8px; background: rgba(0,0,0,0.1); }
        .message { max-width: 80%; padding: 10px 15px; word-wrap: break-word; line-height: 1.4; animation: fadeIn 0.4s; position: relative; overflow: visible !important; cursor: pointer; }
        .message.received { align-self: flex-start; background-color: rgba(255, 255, 255, 0.15); border-radius: 18px 18px 18px 5px; }
        .message.sent { align-self: flex-end; background-color: var(--accent-color); color: white; border-radius: 18px 18px 5px 18px; }
        .username.admin { font-weight: bold; } .username.admin::after { content: ' ★'; color: #ffeb3b; }
        
        /* НОВЫЙ ДИЗАЙН ИГРЫ */
        .tab-buttons { display: flex; border-bottom: 1px solid var(--glass-border); margin-bottom: 20px; }
        .tab-btn { flex: 1; background: none; border: none; color: var(--text-color); opacity: 0.6; padding: 10px; font-size: 1em; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s ease; }
        .tab-btn.active { opacity: 1; border-bottom-color: var(--accent-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .cases-container { display: flex; gap: 20px; justify-content: center; margin-bottom: 20px; }
        .case-card { flex: 1; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--glass-border); }
        .case-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .case-card.disabled { opacity: 0.5; cursor: not-allowed; }
        .case-card .case-icon { font-size: 2.5em; }
        .case-card h4 { margin: 10px 0 5px 0; }
        .case-card p { opacity: 0.8; }
        #roulette-container { position: relative; height: 100px; background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        #roulette-pointer { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 100%; background: #fff; box-shadow: 0 0 10px #fff; z-index: 2; }
        #roulette-strip { display: flex; height: 100%; position: absolute; left: 0; top: 0; transition: transform 5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .roulette-item { width: 100px; height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 5px; font-weight: 600; border-right: 2px solid rgba(0,0,0,0.3); }
        #win-display { min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px; margin: 20px 0; padding: 10px; background: rgba(0,0,0,0.1); }
        #inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; height: 350px; overflow-y: auto; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; }
        .inventory-item { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; text-align: center; border: 2px solid; display: flex; flex-direction: column; justify-content: space-between; }
        .sell-btn { font-size: 0.8em; padding: 5px; margin-top: 10px; background-color: #27ae60; }

        /* Общие стили редкости, админки и эффектов (без изменений) */
        .common { background-color: var(--rarity-common); border-color: var(--rarity-common); color: #111; }
        .rare { background-color: var(--rarity-rare); border-color: var(--rarity-rare); color: #fff; text-shadow: 0 0 5px #000; }
        .epic { background-color: var(--rarity-epic); border-color: var(--rarity-epic); color: #fff; text-shadow: 0 0 5px #000; }
        .legendary { background-color: var(--rarity-legendary); border-color: var(--rarity-legendary); color: #333; text-shadow: 0 0 8px #fff; animation: legendary-glow 2s infinite; }
        @keyframes legendary-glow { 50% { box-shadow: inset 0 0 20px #fff; } }
        .inventory-item.common { border-color: var(--rarity-common); } .inventory-item.rare { border-color: var(--rarity-rare); }
        .inventory-item.epic { border-color: var(--rarity-epic); } .inventory-item.legendary { border-color: var(--rarity-legendary); }
        .context-menu { position: absolute; display: none; z-index: 1000; background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 8px; padding: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 200px; }
        .context-menu button, .context-menu h4 { display: block; background: none; border: none; color: var(--text-color); padding: 10px 15px; width: 100%; text-align: left; cursor: pointer; border-radius: 5px; font-family: 'Montserrat', sans-serif; }
        .context-menu button:hover { background-color: rgba(255, 255, 255, 0.2); }
        .context-menu h4 { font-size: 0.8em; opacity: 0.7; cursor: default; padding-bottom: 5px; }
        .context-menu .submenu-input { width: calc(100% - 30px); margin: 0 15px 10px 15px; }
        .context-menu button.danger { color: var(--danger-color); }
        .message.disintegrating { background-color: transparent !important; box-shadow: none !important; }
        .message.disintegrating .text-content > span { display: inline-block; animation: fallToAbyss 0.5s ease-in forwards; }
        @keyframes fallToAbyss { to { transform: translateY(80px) rotate(90deg); opacity: 0; } }
        #nuke-missile { position: fixed; width: 25px; height: 25px; background: linear-gradient(45deg, #ff4e4e, #ffd2d2); border-radius: 50% 0 50% 50%; box-shadow: 0 0 15px #ff6d6d; z-index: 9999; transform: rotate(45deg); transition: all 1.2s cubic-bezier(0.6, -0.28, 0.735, 0.045); }
        #flash-effect { position: fixed; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(255,255,204,0.5) 50%, rgba(255,255,255,0) 70%); border-radius: 50%; z-index: 9998; opacity: 0; transform: scale(0); pointer-events: none; animation: flashBang 0.5s ease-out forwards; }
        @keyframes flashBang { 0% { opacity: 1; transform: scale(0); } 50% { opacity: 0.8; transform: scale(3); } 100% { opacity: 0; transform: scale(0); } }
        .effect-rainbow { background: linear-gradient(90deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8); background-size: 200% auto; color: transparent; -webkit-background-clip: text; background-clip: text; animation: rainbow-flow 2s linear infinite; }
        @keyframes rainbow-flow { to { background-position: -200% center; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        #blackout-overlay, #screamer-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; display: none; justify-content: center; align-items: center; }
        #blackout-overlay { background-color: black; color: white; font-size: 2em; text-align: center; }
        #screamer-overlay img { max-width: 100%; max-height: 100%; }
        input[type="color"] { padding: 0; height: 40px; border: none; background: none; cursor: pointer; }
    </style>
</head>
<body>
    <div id="background-animation"></div>
    <div class="glass-container">
        <div id="loader-page" class="page active"><h2>Подключение...</h2></div>
        <div id="login-page" class="page"></div>
        <div id="register-page" class="page"></div>

        <div id="chat-page" class="page">
            <div class="page-header">
                <h2>Общий Чат</h2>
                <div class="header-icons">
                    <a href="#" class="link" id="game-hub-btn">🎮</a>
                    <a href="#" class="link" id="settings-btn">⚙️</a>
                </div>
            </div>
            <div id="chat-window"></div>
            <form id="chat-form">
                <input type="text" id="message-input" placeholder="Введите .раз и сообщение..." autocomplete="off" required>
                <button type="submit" class="btn">➤</button>
            </form>
        </div>

        <div id="settings-page" class="page"></div>
        
        <div id="game-hub-page" class="page">
            <div class="page-header">
                <a href="#" class="link back-to-chat-btn">← В чат</a>
                <span id="balance-display">💰 0</span>
            </div>
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="game-tab">Игра</button>
                <button class="tab-btn" data-tab="inventory-tab">Инвентарь</button>
            </div>
            <div id="game-tab" class="tab-content active">
                <div id="win-display"><h3>Откройте кейс!</h3></div>
                <div class="cases-container">
                    <div class="case-card" data-case="bread">
                        <div class="case-icon">🍞</div>
                        <h4>Хлебная Корзина</h4>
                        <p>Цена: 50</p>
                    </div>
                    <div class="case-card" data-case="honey">
                        <div class="case-icon">🍯</div>
                        <h4>Медовый Улей</h4>
                        <p>Цена: 150</p>
                    </div>
                </div>
                <div id="roulette-container">
                    <div id="roulette-pointer"></div>
                    <div id="roulette-strip"></div>
                </div>
                <button id="admin-add-money-btn" class="btn" style="display: none; background-color: #27ae60; margin-top: 20px;">💸 Накрутить баланс</button>
            </div>
            <div id="inventory-tab" class="tab-content">
                <h3 style="text-align:center; margin-bottom: 10px;">Инвентарь (<span id="inventory-value-display">0</span>)</h3>
                <div id="inventory-grid"></div>
            </div>
        </div>
    </div>

    <div id="main-context-menu" class="context-menu"></div>
    <div id="submenu-container" class="context-menu"></div>
    <div id="blackout-overlay"></div>
    <div id="screamer-overlay"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- Конфигурация ---
        const firebaseConfig = {
            apiKey: "AIzaSyBTcH3_tri2L7AHLh1e-YD-0s-QSthuE6Q", authDomain: "disk-c98ee.firebaseapp.com",
            projectId: "disk-c98ee", storageBucket: "disk-c98ee.appspot.com",
            messagingSenderId: "59577059636", appId: "1:59577059636:web:e98f456d054cc360747d61",
            databaseURL: "https://disk-c98ee-default-rtdb.firebaseio.com"
        };
        const ADMIN_KEY = "999";
        const CASES = {
            bread: { name: 'Хлебная Корзина', cost: 50, items: [ { name: 'Черствая горбушка', rarity: 'common', value: 10, chance: 40 }, { name: 'Ломтик Дарницкого', rarity: 'common', value: 25, chance: 30 }, { name: 'Свежий лаваш', rarity: 'rare', value: 75, chance: 15 }, { name: 'Французский круассан', rarity: 'epic', value: 200, chance: 10 }, { name: 'Легендарный багет', rarity: 'legendary', value: 1000, chance: 5 } ] },
            honey: { name: 'Медовый Улей', cost: 150, items: [ { name: 'Цветочный мед', rarity: 'common', value: 50, chance: 40 }, { name: 'Липовый мед', rarity: 'common', value: 80, chance: 30 }, { name: 'Гречишный мед', rarity: 'rare', value: 250, chance: 18 }, { name: 'Эвкалиптовый мед', rarity: 'epic', value: 600, chance: 10 }, { name: 'Нектар богов', rarity: 'legendary', value: 2500, chance: 2 } ] },
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const messagesRef = db.ref('final_chat_v6/messages');
        const usersRef = db.ref('final_chat_v6/users');
        const commandsRef = db.ref('final_chat_v6/commands');
        let listeners = {};
        let currentUserProfile = {};
        
        // --- DOM Элементы ---
        const pages = document.querySelectorAll('.page');
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const settingsPage = document.getElementById('settings-page');
        const gameHubBtn = document.getElementById('game-hub-btn');
        document.querySelectorAll('.back-to-chat-btn').forEach(btn => btn.addEventListener('click', () => showPage('chat-page')));
        const balanceDisplay = document.getElementById('balance-display');
        const caseCards = document.querySelectorAll('.case-card');
        const adminAddMoneyBtn = document.getElementById('admin-add-money-btn');
        const winDisplay = document.getElementById('win-display');
        const inventoryGrid = document.getElementById('inventory-grid');
        const inventoryValueDisplay = document.getElementById('inventory-value-display');
        const mainContextMenu = document.getElementById('main-context-menu');
        const submenuContainer = document.getElementById('submenu-container');
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        
        // --- HTML для страниц ---
        loginPage.innerHTML = `<h2>Вход</h2><form id="login-form"><div class="form-group"><input type="email" id="login-email" required placeholder="Email"></div><div class="form-group"><input type="password" id="login-password" required placeholder="Пароль"></div><button type="submit" class="btn">Войти</button></form><div style="text-align: center; margin-top: 20px;">Нет аккаунта? <a href="#" class="link" onclick="showPage('register-page')">Создать</a></div>`;
        registerPage.innerHTML = `<h2>Регистрация</h2><form id="register-form"><div class="form-group"><input type="email" id="register-email" required placeholder="Email"></div><div class="form-group"><input type="password" id="register-password" required placeholder="Пароль"></div><button type="submit" class="btn">Зарегистрироваться</button></form><div style="text-align: center; margin-top: 20px;">Уже есть? <a href="#" class="link" onclick="showPage('login-page')">Войти</a></div>`;
        settingsPage.innerHTML = `<h2>Настройки</h2><div class="form-group"><label>Ваш никнейм</label><input type="text" id="nickname-input"></div><button id="save-settings-btn" class="btn">Сохранить</button><hr style="border-color: var(--glass-border); margin: 20px 0;"><div id="admin-settings-section" style="display: none;"><h4>Настройки админа</h4><div class="form-group"><label>Цвет ника</label><input type="color" id="nick-color-input"></div><button id="set-rainbow-btn" class="btn">Сделать ник радужным</button><hr style="border-color: var(--glass-border); margin: 20px 0;"></div><div class="form-group"><label>Ключ администратора</label><input type="password" id="admin-key-input" placeholder="Секретный ключ"></div><button id="activate-admin-btn" class="btn">Активировать</button><div style="text-align: center; margin-top: 20px;"><a href="#" class="link back-to-chat-btn">← Назад в чат</a></div>`;
        
        document.getElementById('login-form').addEventListener('submit', (e)=>{e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(e => alert(e.message));});
        document.getElementById('register-form').addEventListener('submit', (e)=>{e.preventDefault(); auth.createUserWithEmailAndPassword(document.getElementById('register-email').value, document.getElementById('register-password').value).catch(e => alert(e.message));});

        // --- Основная логика ---
        function showPage(pageId) { pages.forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); }
        
        function cleanupListeners() {
            Object.values(listeners).forEach(listenerRef => { if(listenerRef && typeof listenerRef.off === 'function') listenerRef.off(); });
            listeners = {};
        }

        auth.onAuthStateChanged(user => {
            cleanupListeners();
            if (user) {
                const userRef = usersRef.child(user.uid);
                listeners.userProfile = userRef.on('value', snapshot => {
                    if (!snapshot.exists()) {
                        userRef.set({ nickname: user.email.split('@')[0], email: user.email, isAdmin: false, isBanned: false, mutedUntil: 0, nicknameColor: 'default', balance: 1000 });
                    } else {
                        currentUserProfile = snapshot.val();
                        if(currentUserProfile.isBanned && (!currentUserProfile.bannedUntil || currentUserProfile.bannedUntil > Date.now())) { auth.signOut(); alert("Вы были забанены."); return; }
                        if (!document.querySelector('.page.active') || document.getElementById('loader-page').classList.contains('active')) showPage('chat-page');
                        listenForMessages();
                        listenForAdminCommands(user.uid);
                        listenForInventory(user.uid);
                        adminAddMoneyBtn.style.display = currentUserProfile.isAdmin ? 'block' : 'none';
                        balanceDisplay.textContent = `💰 ${(currentUserProfile.balance || 0).toLocaleString()}`;
                    }
                });
            } else {
                showPage('login-page');
                currentUserProfile = null;
            }
        });
        
        gameHubBtn.addEventListener('click', () => showPage('game-hub-page'));
        document.querySelectorAll('.back-to-chat-btn').forEach(btn => btn.addEventListener('click', () => showPage('chat-page')));
        
        // --- Логика Игры ---
        let isOpeningCase = false;
        caseCards.forEach(card => card.addEventListener('click', () => openCase(card.dataset.case)));
        
        function openCase(caseId) {
            if (isOpeningCase) return;
            const caseData = CASES[caseId];
            if ((currentUserProfile.balance || 0) < caseData.cost) { alert("Недостаточно средств!"); return; }
            isOpeningCase = true;
            caseCards.forEach(c => c.classList.add('disabled'));
            winDisplay.innerHTML = `<h3>Открываем ${caseData.name}...</h3>`;
            usersRef.child(auth.currentUser.uid).update({ balance: currentUserProfile.balance - caseData.cost });
            const wonItem = getWeightedRandomItem(caseData.items);
            runRouletteAnimation(caseData, wonItem);
        }

        function getWeightedRandomItem(items) {
            let totalChance = items.reduce((sum, item) => sum + item.chance, 0);
            let random = Math.random() * totalChance;
            for (const item of items) { if (random < item.chance) return item; random -= item.chance; }
        }

        function runRouletteAnimation(caseData, wonItem) {
            const strip = document.getElementById('roulette-strip');
            const itemWidth = 100;
            const itemCount = 50;
            strip.innerHTML = '';
            strip.style.transition = 'none';
            strip.style.transform = `translateX(0px)`;
            for (let i = 0; i < itemCount; i++) {
                const item = getWeightedRandomItem(caseData.items);
                const itemEl = document.createElement('div');
                itemEl.className = `roulette-item ${item.rarity}`;
                itemEl.textContent = item.name;
                strip.appendChild(itemEl);
            }
            const winIndex = itemCount - 3;
            const winEl = strip.children[winIndex];
            winEl.className = `roulette-item ${wonItem.rarity}`;
            winEl.textContent = wonItem.name;
            setTimeout(() => {
                const containerWidth = document.getElementById('roulette-container').offsetWidth;
                const randomOffset = (Math.random() - 0.5) * (itemWidth * 0.8);
                const targetPosition = - (winIndex * itemWidth) + (containerWidth / 2) - (itemWidth / 2) + randomOffset;
                strip.style.transition = 'transform 5s cubic-bezier(0.2, 0.8, 0.2, 1)';
                strip.style.transform = `translateX(${targetPosition}px)`;
            }, 100);

            setTimeout(() => {
                winDisplay.innerHTML = `<h3>Выпал предмет:</h3><div class="roulette-item ${wonItem.rarity}" style="margin-top: 5px; width: 150px; height: 100px;">${wonItem.name}</div>`;
                usersRef.child(auth.currentUser.uid).child('inventory').push(wonItem);
                isOpeningCase = false;
                caseCards.forEach(c => c.classList.remove('disabled'));
            }, 5100);
        }
        
        adminAddMoneyBtn.addEventListener('click', () => {
            const amount = parseInt(prompt("Сколько денег накрутить?", "10000"));
            if (amount && !isNaN(amount)) { usersRef.child(auth.currentUser.uid).update({ balance: (currentUserProfile.balance || 0) + amount }); }
        });
        
        // --- Логика Инвентаря и Вкладок ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });

        function listenForInventory(uid) {
            if (listeners.inventory) listeners.inventory.off();
            const inventoryRef = usersRef.child(uid).child('inventory');
            listeners.inventory = inventoryRef.on('value', snapshot => {
                renderInventory(snapshot.val());
            });
        }
        
        function renderInventory(inventoryData) {
            inventoryGrid.innerHTML = '';
            let totalValue = 0;
            if (inventoryData) {
                Object.entries(inventoryData).forEach(([itemId, item]) => {
                    totalValue += item.value;
                    const itemEl = document.createElement('div');
                    itemEl.className = `inventory-item ${item.rarity}`;
                    itemEl.innerHTML = `<p class="item-name">${item.name}</p><p class="item-value">💰 ${item.value}</p><button class="btn sell-btn" data-item-id="${itemId}" data-item-value="${item.value}">Продать</button>`;
                    inventoryGrid.appendChild(itemEl);
                });
            }
            inventoryValueDisplay.textContent = `Стоимость: ${totalValue.toLocaleString()}`;
            document.querySelectorAll('.sell-btn').forEach(btn => btn.addEventListener('click', sellItem));
        }

        function sellItem(e) {
            const { itemId, itemValue } = e.target.dataset;
            const value = parseInt(itemValue);
            usersRef.child(auth.currentUser.uid).update({ balance: (currentUserProfile.balance || 0) + value });
            usersRef.child(auth.currentUser.uid).child('inventory').child(itemId).remove();
        }
        
        // --- КОД ЧАТА И АДМИНКИ (ИЗ ПРЕДЫДУЩЕЙ ВЕРСИИ) ---
        (function attachFullJS() {
            const settingsDOM = {
                settingsBtn: document.getElementById('settings-btn'),
                backToChatBtn: document.querySelector('#settings-page .back-to-chat-btn'),
                nicknameInput: document.getElementById('nickname-input'),
                saveSettingsBtn: document.getElementById('save-settings-btn'),
                adminKeyInput: document.getElementById('admin-key-input'),
                activateAdminBtn: document.getElementById('activate-admin-btn'),
                adminSettingsSection: document.getElementById('admin-settings-section'),
                nickColorInput: document.getElementById('nick-color-input'),
                setRainbowBtn: document.getElementById('set-rainbow-btn'),
            };

            settingsDOM.settingsBtn.addEventListener('click', () => {
                settingsDOM.nicknameInput.value = currentUserProfile.nickname;
                if (currentUserProfile.isAdmin) {
                    settingsDOM.adminSettingsSection.style.display = 'block';
                    settingsDOM.nickColorInput.value = currentUserProfile.nicknameColor === 'rainbow' || currentUserProfile.nicknameColor === 'default' ? '#ffffff' : currentUserProfile.nicknameColor;
                } else {
                    settingsDOM.adminSettingsSection.style.display = 'none';
                }
                showPage('settings-page');
            });
            settingsDOM.backToChatBtn.addEventListener('click', () => showPage('chat-page'));
            settingsDOM.saveSettingsBtn.addEventListener('click', () => {
                const newNickname = settingsDOM.nicknameInput.value.trim();
                const updates = {};
                if (newNickname) updates.nickname = newNickname;
                if (currentUserProfile.isAdmin) { updates.nicknameColor = settingsDOM.nickColorInput.value; }
                if (Object.keys(updates).length > 0) usersRef.child(auth.currentUser.uid).update(updates);
                alert("Настройки сохранены!");
                showPage('chat-page');
            });
            settingsDOM.setRainbowBtn.addEventListener('click', () => {
                usersRef.child(auth.currentUser.uid).update({ nicknameColor: 'rainbow' });
                alert("Радужный ник установлен!");
            });
            settingsDOM.activateAdminBtn.addEventListener('click', () => {
                if (settingsDOM.adminKeyInput.value === ADMIN_KEY) { usersRef.child(auth.currentUser.uid).update({ isAdmin: true }); alert("Режим администратора активирован!"); }
                else { alert("Неверный ключ."); }
            });

            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const rawMessage = messageInput.value.trim();
                if (!rawMessage || !currentUserProfile) return;
                if (currentUserProfile.mutedUntil && currentUserProfile.mutedUntil > Date.now()) {
                    alert(`Вы не можете писать еще ${Math.ceil((currentUserProfile.mutedUntil - Date.now()) / 1000)} секунд.`);
                    return;
                }
                let messageText = rawMessage, messageEffect = 'none';
                const parts = rawMessage.split(' ');
                const command = parts[0].toLowerCase();
                if (command === '.раз' && currentUserProfile.isAdmin) {
                    messageEffect = 'rainbow';
                    messageText = parts.slice(1).join(' ');
                }
                if (messageText) messagesRef.push({ text: messageText, uid: auth.currentUser.uid, nickname: currentUserProfile.nickname, isAdmin: currentUserProfile.isAdmin || false, effect: messageEffect, nicknameColor: currentUserProfile.nicknameColor || 'default' });
                messageInput.value = '';
            });

            function displayMessage(messageKey, message) {
                const user = auth.currentUser;
                const messageElement = document.createElement('div');
                messageElement.id = `msg-${messageKey}`;
                messageElement.className = 'message';
                messageElement.dataset.messageKey = messageKey;
                messageElement.dataset.senderUid = message.uid;
                messageElement.dataset.senderNickname = message.nickname;
                const usernameElement = document.createElement('span');
                usernameElement.className = 'username';
                usernameElement.textContent = message.nickname;
                if (message.isAdmin) {
                    usernameElement.classList.add('admin');
                    if(message.nicknameColor === 'rainbow') {
                        usernameElement.classList.add('effect-rainbow');
                    } else if (message.nicknameColor && message.nicknameColor !== 'default') {
                        usernameElement.style.color = message.nicknameColor;
                    }
                }
                const textElement = document.createElement('span');
                textElement.className = 'text-content';
                textElement.textContent = message.text;
                if (user && user.uid === message.uid) messageElement.classList.add('sent');
                else messageElement.classList.add('received');
                messageElement.appendChild(usernameElement);
                messageElement.appendChild(textElement);
                chatWindow.appendChild(messageElement);
                if(chatWindow.scrollHeight - chatWindow.scrollTop < chatWindow.clientHeight + 150) {
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
                messageElement.addEventListener('contextmenu', handleContextMenu);
                if (message.effect === 'rainbow' && message.isAdmin) { textElement.classList.add('effect-rainbow'); }
            }
            
            function handleContextMenu(e) {
                e.preventDefault();
                hideMenus();
                const targetMessage = e.currentTarget;
                const { messageKey, senderUid, senderNickname } = targetMessage.dataset;
                mainContextMenu.innerHTML = '';
                if (currentUserProfile.isAdmin) {
                    mainContextMenu.innerHTML = `<button data-action="mute">Выдать мут</button><button data-action="ban">Выдать бан</button><hr style="border-color: var(--glass-border); margin: 5px;"><button data-action="delete" class="danger">Уничтожить</button><button data-action="blackout" class="danger">Черный экран</button><button data-action="scream" class="danger">Скример</button>`;
                } else if (senderUid === auth.currentUser.uid) {
                    mainContextMenu.innerHTML = `<button data-action="delete" class="danger">Удалить</button>`;
                } else { return; }
                mainContextMenu.style.top = `${e.clientY}px`;
                mainContextMenu.style.left = `${e.clientX}px`;
                mainContextMenu.style.display = 'block';
                const menuClickHandler = (event) => {
                    event.stopPropagation();
                    const action = event.target.dataset.action;
                    if (!action) return;
                    mainContextMenu.style.display = 'none';
                    switch(action) {
                        case 'delete': messagesRef.child(messageKey).remove(); break;
                        case 'mute': showSubMenu('mute', senderUid, senderNickname, e); break;
                        case 'ban': showSubMenu('ban', senderUid, senderNickname, e); break;
                        case 'blackout': sendAdminCommand(senderUid, 'blackout'); break;
                        case 'scream': sendAdminCommand(senderUid, 'screamer'); break;
                    }
                };
                mainContextMenu.replaceWith(mainContextMenu.cloneNode(true));
                document.getElementById('main-context-menu').addEventListener('click', menuClickHandler);
            }
            
            function showSubMenu(type, uid, nickname, originalEvent) {
                submenuContainer.innerHTML = '';
                let content = '';
                if (type === 'mute') {
                    content = `<h4>Мут для ${nickname}</h4><input type="number" class="submenu-input" id="duration-input" placeholder="Время в минутах"><button data-action="give">Выдать</button><button data-action="remove">Снять</button>`;
                } else if (type === 'ban') {
                    content = `<h4>Бан для ${nickname}</h4><input type="number" class="submenu-input" id="duration-input" placeholder="Время в днях"><button data-action="give">Выдать</button><button data-action="remove">Снять</button>`;
                }
                submenuContainer.innerHTML = content;
                submenuContainer.style.top = `${originalEvent.clientY}px`;
                submenuContainer.style.left = `${originalEvent.clientX}px`;
                submenuContainer.style.display = 'block';
                const submenuClickHandler = (event) => {
                    event.stopPropagation();
                    const action = event.target.dataset.action;
                    if (!action) return;
                    if (type === 'mute') {
                        if(action === 'give') {
                            const duration = parseInt(document.getElementById('duration-input').value) || 5;
                            usersRef.child(uid).update({ mutedUntil: Date.now() + duration * 60 * 1000 });
                            alert(`${nickname} получил мут на ${duration} минут.`);
                        } else {
                            usersRef.child(uid).update({ mutedUntil: 0 });
                            alert(`Мут с ${nickname} снят.`);
                        }
                    } else if (type === 'ban') {
                        if(action === 'give') {
                            const duration = parseInt(document.getElementById('duration-input').value);
                            const banUntil = duration ? Date.now() + duration * 24 * 60 * 60 * 1000 : null;
                            usersRef.child(uid).update({ isBanned: true, bannedUntil: banUntil });
                            alert(`${nickname} забанен ${duration ? `на ${duration} дней` : 'навсегда'}.`);
                        } else {
                            usersRef.child(uid).update({ isBanned: false, bannedUntil: null });
                            alert(`Бан с ${nickname} снят.`);
                        }
                    }
                    hideMenus();
                };
                submenuContainer.replaceWith(submenuContainer.cloneNode(true));
                document.getElementById('submenu-container').addEventListener('click', submenuClickHandler);
            }

            function hideMenus() {
                document.getElementById('main-context-menu').style.display = 'none';
                document.getElementById('submenu-container').style.display = 'none';
            }
            window.addEventListener('click', hideMenus);

            function sendAdminCommand(targetUid, commandType) { commandsRef.child(targetUid).set({ type: commandType }); }
            function listenForAdminCommands(myUid) {
                if (listeners.commands) listeners.commands.off();
                const myCommandsRef = commandsRef.child(myUid);
                listeners.commands = myCommandsRef.on('value', snapshot => {
                    if (!snapshot.exists()) return;
                    const command = snapshot.val();
                    switch(command.type) {
                        case 'blackout': document.getElementById('blackout-overlay').innerHTML = `<p>Администратор применил к вам санкции.</p>`; document.getElementById('blackout-overlay').style.display = 'flex'; break;
                        case 'screamer': document.getElementById('screamer-overlay').style.display = 'flex'; document.getElementById('screamer-audio').play(); setTimeout(() => document.getElementById('screamer-overlay').style.display = 'none', 3000); break;
                    }
                    myCommandsRef.remove();
                });
            }
            
            function initiateDestructionSequence(msgElement, rect) {
                const missile = document.createElement('div'); missile.id = 'nuke-missile'; document.body.appendChild(missile);
                const targetX = rect.left + rect.width / 2; const targetY = rect.top + rect.height / 2;
                const startPos = { x: Math.random() * window.innerWidth, y: -50 }; missile.style.left = `${startPos.x}px`; missile.style.top = `${startPos.y}px`;
                setTimeout(() => { missile.style.left = `${targetX}px`; missile.style.top = `${targetY}px`; missile.style.transform = 'rotate(225deg) scale(0.5)'; }, 100);
                setTimeout(() => {
                    missile.remove();
                    const flash = document.createElement('div'); flash.id = 'flash-effect';
                    flash.style.left = `${targetX - 100}px`; flash.style.top = `${targetY - 100}px`;
                    document.body.appendChild(flash);
                    setTimeout(() => flash.remove(), 500);
                    msgElement.classList.add('disintegrating');
                    const textEl = msgElement.querySelector('.text-content');
                    const chars = textEl.textContent.split('');
                    textEl.innerHTML = '';
                    chars.forEach((char, i) => {
                        const span = document.createElement('span');
                        span.textContent = char === ' ' ? '\u00A0' : char;
                        span.style.animationDelay = `${i * 0.02}s`;
                        textEl.appendChild(span);
                    });
                    setTimeout(() => {
                        const particleOrigin = document.createElement('div'); particleOrigin.style.position = 'fixed'; particleOrigin.style.top = `${targetY}px`; particleOrigin.style.left = `${targetX}px`;
                        document.body.appendChild(particleOrigin); createExplosionParticles(particleOrigin); setTimeout(() => particleOrigin.remove(), 1100);
                    }, 400);
                }, 1300);
            }

            function createExplosionParticles(containerElement) {
                const particlesCount = 50; const colors = ['#FFC700', '#FF7A00', '#FFFFFF', '#808080', '#ff4040'];
                for (let i = 0; i < particlesCount; i++) {
                    const particle = document.createElement('div');
                    const x = (Math.random() - 0.5) * 2 * 250; const y = (Math.random() - 0.5) * 2 * 250;
                    const color = colors[Math.floor(Math.random() * colors.length)]; const size = Math.random() * 8 + 3;
                    particle.style.cssText = `position: absolute; width: ${size}px; height: ${size}px; background: ${color}; border-radius: 50%; animation: particle-anim 1s ease-out forwards;`;
                    particle.style.animationName = 'particle-anim'; // Assign animation
                    const keyframes = `@keyframes particle-anim { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(${x}px, ${y}px) scale(0); opacity: 0; } }`;
                    if(!document.getElementById('particle-keyframes')) {
                        const styleSheet = document.createElement("style");
                        styleSheet.id = 'particle-keyframes';
                        styleSheet.innerText = keyframes;
                        document.head.appendChild(styleSheet);
                    }
                    containerElement.appendChild(particle); setTimeout(() => particle.remove(), 1000);
                }
            }
        })();
    </script>
</body>
</html>
