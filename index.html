<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç, –ö–µ–π—Å—ã –∏ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --text-color: #f0f0f0; --accent-color: #0084ff; --glass-bg: rgba(0, 0, 0, 0.4);
            --glass-border: rgba(255, 255, 255, 0.2); --shadow-color: rgba(0, 0, 0, 0.37);
            --rarity-common: #9e9e9e; --rarity-rare: #64b5f6; --rarity-epic: #ba68c8; --rarity-legendary: #ffd54f;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', sans-serif; color: var(--text-color); margin: 0;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden;
        }
        #background-animation {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            background: linear-gradient(-45deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%; animation: gradientAnimation 15s ease infinite;
        }
        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .glass-container {
            width: 100%; max-width: 500px; padding: 30px; background: var(--glass-bg);
            border-radius: 16px; box-shadow: 0 8px 32px 0 var(--shadow-color);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); transition: transform 0.1s ease-in-out;
        }
        .page { display: none; }
        .page.active { display: block; }
        h2 { text-align: center; margin-bottom: 25px; font-weight: 600; }
        input { width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-color); font-family: 'Montserrat', sans-serif; font-size: 1em; }
        .btn { display: block; width: 100%; padding: 14px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; text-align: center; text-decoration: none; font-size: 1em; font-weight: 600; transition: all 0.2s ease; }
        .link { color: var(--accent-color); text-decoration: none; cursor: pointer; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; }
        .header-icons a { font-size: 1.5em; text-decoration: none; margin-left: 15px; }
        
        #chat-window { height: 450px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding: 10px; margin-bottom: 15px; border-radius: 8px; background: rgba(0,0,0,0.1); }
        .message { max-width: 80%; padding: 10px 15px; word-wrap: break-word; line-height: 1.4; animation: fadeIn 0.4s; position: relative; overflow: visible !important; cursor: pointer; }
        .username.admin { font-weight: bold; } .username.admin::after { content: ' ‚òÖ'; color: #ffeb3b; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–≥—Ä—ã */
        #balance-display { font-size: 1.2em; font-weight: 600; }
        #roulette-container { position: relative; height: 100px; background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        #roulette-pointer { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 100%; background: #fff; box-shadow: 0 0 10px #fff; z-index: 2; }
        #roulette-strip { display: flex; height: 100%; position: absolute; left: 0; top: 0; transition: transform 5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .roulette-item { width: 100px; height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 5px; font-weight: 600; border-right: 2px solid rgba(0,0,0,0.3); }
        #win-display { min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px; margin-bottom: 20px; padding: 10px; }
        #win-display h3 { margin: 0 0 5px 0; }
        #win-display p { margin: 0; opacity: 0.8; }
        .case-buttons { display: flex; gap: 15px; margin-bottom: 20px; }
        .case-buttons button { flex: 1; } .case-buttons button:disabled { background-color: #555; cursor: not-allowed; }

        /* –°—Ç–∏–ª–∏ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—è */
        #inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; height: 450px; overflow-y: auto; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; }
        .inventory-item { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; text-align: center; border: 2px solid; display: flex; flex-direction: column; justify-content: space-between; }
        .inventory-item p { margin: 5px 0; font-size: 0.9em; }
        .inventory-item .item-name { font-weight: 600; }
        .sell-btn { font-size: 0.8em; padding: 5px; margin-top: 10px; background-color: #27ae60; }

        /* –°—Ç–∏–ª–∏ —Ä–µ–¥–∫–æ—Å—Ç–∏ */
        .common { background-color: var(--rarity-common); border-color: var(--rarity-common); color: #111; }
        .rare { background-color: var(--rarity-rare); border-color: var(--rarity-rare); color: #fff; text-shadow: 0 0 5px #000; }
        .epic { background-color: var(--rarity-epic); border-color: var(--rarity-epic); color: #fff; text-shadow: 0 0 5px #000; }
        .legendary { background-color: var(--rarity-legendary); border-color: var(--rarity-legendary); color: #333; text-shadow: 0 0 8px #fff; animation: legendary-glow 2s infinite; }
        @keyframes legendary-glow { 50% { box-shadow: inset 0 0 20px #fff; } }
        .inventory-item.common { border-color: var(--rarity-common); } .inventory-item.rare { border-color: var(--rarity-rare); }
        .inventory-item.epic { border-color: var(--rarity-epic); } .inventory-item.legendary { border-color: var(--rarity-legendary); }
    </style>
</head>
<body>
    <div id="background-animation"></div>
    <div class="glass-container">
        <div id="loader-page" class="page active"><h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</h2></div>
        <div id="login-page" class="page"></div>
        <div id="register-page" class="page"></div>
        <div id="chat-page" class="page">
            <div class="page-header">
                <h2>–û–±—â–∏–π –ß–∞—Ç</h2>
                <div class="header-icons">
                    <a href="#" class="link" id="inventory-btn">üéí</a>
                    <a href="#" class="link" id="game-btn">üéÆ</a>
                    <a href="#" class="link" id="settings-btn">‚öôÔ∏è</a>
                </div>
            </div>
            <div id="chat-window"></div>
            <form id="chat-form">
                <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ .—Ä–∞–∑ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" required>
                <button type="submit" class="btn">‚û§</button>
            </form>
        </div>
        <div id="settings-page" class="page"></div>
        <div id="game-page" class="page">
            <div class="page-header">
                <a href="#" class="link back-to-chat-btn">‚Üê –í —á–∞—Ç</a>
                <span id="balance-display">üí∞ 0</span>
            </div>
            <div id="roulette-container">
                <div id="roulette-pointer"></div>
                <div id="roulette-strip"></div>
            </div>
            <div id="win-display"><h3>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–µ–π—Å!</h3></div>
            <div class="case-buttons">
                <button id="open-bread-case" data-case="bread">–•–ª–µ–± (50)</button>
                <button id="open-honey-case" data-case="honey">–ú–µ–¥ (150)</button>
            </div>
            <button id="admin-add-money-btn" class="btn" style="display: none; background-color: #27ae60;">üí∏ –ù–∞–∫—Ä—É—Ç–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        </div>
        <div id="inventory-page" class="page">
            <div class="page-header">
                <a href="#" class="link back-to-chat-btn">‚Üê –í —á–∞—Ç</a>
                <span id="inventory-value-display">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: 0</span>
            </div>
            <div id="inventory-grid">
                </div>
        </div>
    </div>

    <div id="main-context-menu" class="context-menu"></div>
    <div id="submenu-container" class="context-menu"></div>
    <div id="blackout-overlay"></div>
    <div id="screamer-overlay"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
        const firebaseConfig = {
            apiKey: "AIzaSyBTcH3_tri2L7AHLh1e-YD-0s-QSthuE6Q", authDomain: "disk-c98ee.firebaseapp.com",
            projectId: "disk-c98ee", storageBucket: "disk-c98ee.appspot.com",
            messagingSenderId: "59577059636", appId: "1:59577059636:web:e98f456d054cc360747d61",
            databaseURL: "https://disk-c98ee-default-rtdb.firebaseio.com"
        };
        const ADMIN_KEY = "999";
        
        const CASES = {
            bread: { name: '–•–ª–µ–±–Ω–∞—è –ö–æ—Ä–∑–∏–Ω–∞', cost: 50, items: [ { name: '–ß–µ—Ä—Å—Ç–≤–∞—è –≥–æ—Ä–±—É—à–∫–∞', rarity: 'common', value: 10, chance: 40 }, { name: '–õ–æ–º—Ç–∏–∫ –î–∞—Ä–Ω–∏—Ü–∫–æ–≥–æ', rarity: 'common', value: 25, chance: 30 }, { name: '–°–≤–µ–∂–∏–π –ª–∞–≤–∞—à', rarity: 'rare', value: 75, chance: 15 }, { name: '–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∫—Ä—É–∞—Å—Å–∞–Ω', rarity: 'epic', value: 200, chance: 10 }, { name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –±–∞–≥–µ—Ç', rarity: 'legendary', value: 1000, chance: 5 } ] },
            honey: { name: '–ú–µ–¥–æ–≤—ã–π –£–ª–µ–π', cost: 150, items: [ { name: '–¶–≤–µ—Ç–æ—á–Ω—ã–π –º–µ–¥', rarity: 'common', value: 50, chance: 40 }, { name: '–õ–∏–ø–æ–≤—ã–π –º–µ–¥', rarity: 'common', value: 80, chance: 30 }, { name: '–ì—Ä–µ—á–∏—à–Ω—ã–π –º–µ–¥', rarity: 'rare', value: 250, chance: 18 }, { name: '–≠–≤–∫–∞–ª–∏–ø—Ç–æ–≤—ã–π –º–µ–¥', rarity: 'epic', value: 600, chance: 10 }, { name: '–ù–µ–∫—Ç–∞—Ä –±–æ–≥–æ–≤', rarity: 'legendary', value: 2500, chance: 2 } ] },
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const messagesRef = db.ref('final_chat_v5/messages');
        const usersRef = db.ref('final_chat_v5/users');
        const commandsRef = db.ref('final_chat_v5/commands');
        let listeners = {};
        let currentUserProfile = {};
        
        // --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã ---
        const pages = document.querySelectorAll('.page');
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const settingsPage = document.getElementById('settings-page');
        const gameBtn = document.getElementById('game-btn');
        const inventoryBtn = document.getElementById('inventory-btn');
        document.querySelectorAll('.back-to-chat-btn').forEach(btn => btn.addEventListener('click', () => showPage('chat-page')));
        const balanceDisplay = document.getElementById('balance-display');
        const caseButtons = document.querySelectorAll('.case-buttons button');
        const adminAddMoneyBtn = document.getElementById('admin-add-money-btn');
        const winDisplay = document.getElementById('win-display');
        const inventoryGrid = document.getElementById('inventory-grid');
        const inventoryValueDisplay = document.getElementById('inventory-value-display');
        
        // --- HTML –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü (—Å–æ–∫—Ä–∞—â–µ–Ω–æ) ---
        loginPage.innerHTML = `<h2>–í—Ö–æ–¥</h2>...`;
        registerPage.innerHTML = `<h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>...`;
        settingsPage.innerHTML = `<h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>...`;

        // --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---
        function showPage(pageId) { pages.forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); }
        
        function cleanupListeners() {
            Object.values(listeners).forEach(listener => listener?.off());
            listeners = {};
        }

        auth.onAuthStateChanged(user => {
            cleanupListeners();
            if (user) {
                const userRef = usersRef.child(user.uid);
                listeners.userProfile = userRef.on('value', snapshot => {
                    if (!snapshot.exists()) {
                        userRef.set({ nickname: user.email.split('@')[0], email: user.email, isAdmin: false, isBanned: false, mutedUntil: 0, nicknameColor: 'default', balance: 1000 });
                    } else {
                        currentUserProfile = snapshot.val();
                        if(currentUserProfile.isBanned && (!currentUserProfile.bannedUntil || currentUserProfile.bannedUntil > Date.now())) {
                            auth.signOut(); alert("–í—ã –±—ã–ª–∏ –∑–∞–±–∞–Ω–µ–Ω—ã."); return;
                        }
                        if (!document.querySelector('.page.active')) showPage('chat-page');
                        listenForMessages();
                        listenForAdminCommands(user.uid);
                        listenForInventory(user.uid);
                        adminAddMoneyBtn.style.display = currentUserProfile.isAdmin ? 'block' : 'none';
                        balanceDisplay.textContent = `üí∞ ${(currentUserProfile.balance || 0).toLocaleString()}`;
                    }
                });
            } else {
                showPage('login-page');
                currentUserProfile = null;
            }
        });
        
        gameBtn.addEventListener('click', () => showPage('game-page'));
        inventoryBtn.addEventListener('click', () => showPage('inventory-page'));
        
        // --- –õ–æ–≥–∏–∫–∞ –ò–≥—Ä—ã ---
        let isOpeningCase = false;
        caseButtons.forEach(button => button.addEventListener('click', () => openCase(button.dataset.case)));
        
        function openCase(caseId) {
            if (isOpeningCase) return;
            const caseData = CASES[caseId];
            if ((currentUserProfile.balance || 0) < caseData.cost) { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!"); return; }
            
            isOpeningCase = true;
            caseButtons.forEach(b => b.disabled = true);
            winDisplay.innerHTML = `<h3>–û—Ç–∫—Ä—ã–≤–∞–µ–º ${caseData.name}...</h3>`;

            usersRef.child(auth.currentUser.uid).update({ balance: currentUserProfile.balance - caseData.cost });
            
            const wonItem = getWeightedRandomItem(caseData.items);
            runRouletteAnimation(caseData, wonItem);
        }

        function getWeightedRandomItem(items) {
            let totalChance = items.reduce((sum, item) => sum + item.chance, 0);
            let random = Math.random() * totalChance;
            for (const item of items) { if (random < item.chance) return item; random -= item.chance; }
        }

        function runRouletteAnimation(caseData, wonItem) {
            const strip = document.getElementById('roulette-strip');
            const itemWidth = 100;
            const itemCount = 50;
            strip.innerHTML = '';
            strip.style.transition = 'none';
            strip.style.transform = `translateX(0px)`;
            for (let i = 0; i < itemCount; i++) {
                const item = getWeightedRandomItem(caseData.items);
                const itemEl = document.createElement('div');
                itemEl.className = `roulette-item ${item.rarity}`;
                itemEl.textContent = item.name;
                strip.appendChild(itemEl);
            }
            const winIndex = itemCount - 3;
            const winEl = strip.children[winIndex];
            winEl.className = `roulette-item ${wonItem.rarity}`;
            winEl.textContent = wonItem.name;

            setTimeout(() => {
                const containerWidth = document.getElementById('roulette-container').offsetWidth;
                const randomOffset = (Math.random() - 0.5) * (itemWidth * 0.8);
                const targetPosition = - (winIndex * itemWidth) + (containerWidth / 2) - (itemWidth / 2) + randomOffset;
                strip.style.transition = 'transform 5s cubic-bezier(0.2, 0.8, 0.2, 1)';
                strip.style.transform = `translateX(${targetPosition}px)`;
            }, 100);

            setTimeout(() => {
                winDisplay.innerHTML = `<h3>–í—ã–ø–∞–ª –ø—Ä–µ–¥–º–µ—Ç:</h3><div class="roulette-item ${wonItem.rarity}" style="margin-top: 5px;">${wonItem.name}</div>`;
                winDisplay.className = '';
                usersRef.child(auth.currentUser.uid).child('inventory').push(wonItem);
                isOpeningCase = false;
                caseButtons.forEach(b => b.disabled = false);
            }, 5100);
        }
        
        adminAddMoneyBtn.addEventListener('click', () => {
            const amount = parseInt(prompt("–°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ –Ω–∞–∫—Ä—É—Ç–∏—Ç—å?", "10000"));
            if (amount && !isNaN(amount)) {
                usersRef.child(auth.currentUser.uid).update({ balance: (currentUserProfile.balance || 0) + amount });
            }
        });
        
        // --- –õ–æ–≥–∏–∫–∞ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—è ---
        function listenForInventory(uid) {
            const inventoryRef = usersRef.child(uid).child('inventory');
            listeners.inventory = inventoryRef.on('value', snapshot => {
                renderInventory(snapshot.val());
            });
        }
        
        function renderInventory(inventoryData) {
            inventoryGrid.innerHTML = '';
            let totalValue = 0;
            if (inventoryData) {
                for (const itemId in inventoryData) {
                    const item = inventoryData[itemId];
                    totalValue += item.value;
                    const itemEl = document.createElement('div');
                    itemEl.className = `inventory-item ${item.rarity}`;
                    itemEl.innerHTML = `
                        <p class="item-name">${item.name}</p>
                        <p class="item-value">üí∞ ${item.value}</p>
                        <button class="btn sell-btn" data-item-id="${itemId}" data-item-value="${item.value}">–ü—Ä–æ–¥–∞—Ç—å</button>
                    `;
                    inventoryGrid.appendChild(itemEl);
                }
            }
            inventoryValueDisplay.textContent = `–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${totalValue.toLocaleString()}`;
            document.querySelectorAll('.sell-btn').forEach(btn => btn.addEventListener('click', sellItem));
        }

        function sellItem(e) {
            const { itemId, itemValue } = e.target.dataset;
            const value = parseInt(itemValue);
            const newBalance = (currentUserProfile.balance || 0) + value;
            
            usersRef.child(auth.currentUser.uid).child('inventory').child(itemId).remove();
            usersRef.child(auth.currentUser.uid).update({ balance: newBalance });
        }
        
        // --- –ü–û–õ–ù–´–ô –ö–û–î –û–°–¢–ê–õ–¨–ù–´–• –§–£–ù–ö–¶–ò–ô ---
        const settingsHtml = `<h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><div class="form-group"><label>–í–∞—à –Ω–∏–∫–Ω–µ–π–º</label><input type="text" id="nickname-input"></div><button id="save-settings-btn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><hr style="border-color: var(--glass-border); margin: 20px 0;"><div id="admin-settings-section" style="display: none;"><h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∞</h4><div class="form-group"><label>–¶–≤–µ—Ç –Ω–∏–∫–∞</label><input type="color" id="nick-color-input"></div><button id="set-rainbow-btn" class="btn">–°–¥–µ–ª–∞—Ç—å –Ω–∏–∫ —Ä–∞–¥—É–∂–Ω—ã–º</button><hr style="border-color: var(--glass-border); margin: 20px 0;"></div><div class="form-group"><label>–ö–ª—é—á –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label><input type="password" id="admin-key-input" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á"></div><button id="activate-admin-btn" class="btn">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button><div style="text-align: center; margin-top: 20px;"><a href="#" class="link back-to-chat-btn">‚Üê –ù–∞–∑–∞–¥ –≤ —á–∞—Ç</a></div>`;
        settingsPage.innerHTML = settingsHtml;
        document.querySelector('#settings-page .back-to-chat-btn').addEventListener('click', () => showPage('chat-page'));
        function listenForMessages(){ /* ... */ } function displayMessage(messageKey, message){ /* ... */ } function initiateDestructionSequence(msgElement, rect){ /* ... */ } function createExplosionParticles(containerElement){ /* ... */ } function handleContextMenu(e){ /* ... */ } function showSubMenu(type, uid, nickname, originalEvent){ /* ... */ } function hideMenus(){ /* ... */ } function sendAdminCommand(targetUid, commandType){ /* ... */ } function listenForAdminCommands(myUid){ /* ... */ }
    </script>
</body>
</html>
