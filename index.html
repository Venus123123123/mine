<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Сапёр 1win с сохранением и админ-консолью</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');
  body {
    margin: 0; padding: 0;
    background: #121b2f;
    color: #cbd5e1;
    font-family: 'Orbitron', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    user-select: none;
  }
  #balance {
    margin: 20px 0;
    font-size: 1.8rem;
    color: #60a5fa;
    text-shadow: 0 0 6px #2563eb;
  }
  #levelInfo {
    margin-bottom: 12px;
    font-size: 1.5rem;
    color: #a5b4fc;
    display: flex;
    align-items: center;
    gap: 8px;
    user-select: none;
  }
  #multiplier {
    font-weight: 900;
    font-size: 1.8rem;
    color: #facc15;
    text-shadow: 0 0 6px #eab308;
  }
  #arrow {
    width: 20px;
    height: 20px;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 10px solid #facc15;
    animation: bounce 1.2s infinite;
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
  }
  #betContainer {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
  }
  #betInput {
    font-size: 1.3rem;
    padding: 10px 14px;
    border-radius: 12px;
    border: none;
    width: 160px;
    text-align: center;
    font-weight: 700;
    box-shadow: 0 0 15px #2563eb;
    color: #121b2f;
    user-select: text;
  }
  #startBtn, #takeBtn {
    background: #10b981;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 1.4rem;
    padding: 12px 40px;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 0 15px #10b981;
    transition: background 0.3s, opacity 1s ease;
  }
  #startBtn:disabled {
    background: #065f46;
    cursor: not-allowed;
    box-shadow: none;
  }
  #startBtn:hover:not(:disabled), #takeBtn:hover {
    background: #059669;
    box-shadow: 0 0 25px #059669;
  }
  #takeBtn.hidden, #startBtn.hidden, #betContainer.hidden {
    opacity: 0;
    pointer-events: none;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(3, 60px);
    grid-template-rows: repeat(10, 60px);
    gap: 8px;
    background: #1e293b;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 0 20px #2563eb;
    position: relative;
    user-select: none;
    margin-bottom: 20px;
  }
  .cell {
    width: 60px;
    height: 60px;
    background: #334155;
    border-radius: 10px;
    box-shadow:
      inset 0 2px 5px rgba(255,255,255,0.15),
      0 2px 8px rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2.2rem;
    font-weight: 900;
    color: transparent;
    cursor: pointer;
    position: relative;
    transition: background 0.3s, color 0.3s;
  }
  .cell:hover:not(.opened):not(.disabled) {
    background: #3b82f6;
    box-shadow: 0 0 12px #3b82f6;
  }
  .cell.opened {
    background: #e0e7ff;
    color: #1e293b;
    cursor: default;
    box-shadow: inset 0 0 14px #2563eb;
  }
  .cell.mine {
    background: #dc2626;
    color: #fef3f3;
    box-shadow: 0 0 20px #dc2626;
    animation: pulseRed 1.2s infinite alternate;
  }
  @keyframes pulseRed {
    0% { box-shadow: 0 0 15px #dc2626; }
    100% { box-shadow: 0 0 25px #f87171; }
  }
  @keyframes greenGlow {
    0% {
      background-color: #e0e7ff;
      box-shadow: inset 0 0 5px #22c55e;
      color: #166534;
    }
    50% {
      background-color: #d1fae5;
      box-shadow: inset 0 0 20px #22c55e;
      color: #14532d;
    }
    100% {
      background-color: #e0e7ff;
      box-shadow: inset 0 0 5px #22c55e;
      color: #166534;
    }
  }
  .cell.correct {
    animation: greenGlow 2s ease-in-out infinite;
  }
  #message {
    font-size: 2rem;
    font-weight: 900;
    min-height: 36px;
    color: #ef4444;
    text-shadow: 0 0 15px #dc2626;
    margin-bottom: 10px;
    opacity: 1;
    transition: opacity 1.5s ease;
  }
  #message.hidden {
    opacity: 0;
  }

  /* Админ-консоль */
  #adminConsole {
    position: fixed;
    bottom: 0;
    left: 0; right: 0;
    background: #222;
    color: #0f0;
    font-family: monospace;
    max-height: 150px;
    overflow-y: auto;
    padding: 8px;
    display: none;
    z-index: 9999;
  }
  #consoleOutput {
    height: 110px;
    overflow-y: auto;
    white-space: pre-wrap;
  }
  #consoleInput {
    width: 100%;
    background: #000;
    color: #0f0;
    border: none;
    padding: 6px;
    font-family: monospace;
  }
</style>
</head>
<body>

  <div id="balance">Баланс: $5,000,000</div>

  <div id="levelInfo" style="display:none;">
    <div>Уровень: <span id="level">1</span></div>
    <div id="arrow"></div>
    <div>Множитель: <span id="multiplier">x2</span></div>
  </div>

  <div id="betContainer">
    <input id="betInput" type="number" min="1" max="1000000" step="1" placeholder="Введите ставку (USD)" />
    <button id="startBtn" disabled>Начать</button>
  </div>

  <div id="board" aria-label="Игровое поле сапёра" role="grid" style="display:none;"></div>

  <button id="takeBtn" class="hidden">Забрать</button>

  <div id="message" class="hidden" role="alert"></div>

  <!-- Админ-консоль -->
  <div id="adminConsole">
    <div id="consoleOutput"></div>
    <input id="consoleInput" placeholder="Введите команду..."/>
  </div>

<script>
  const ROWS = 10;
  const COLS = 3;

  let balance = 5000000;
  let bet = null;
  let board = [];
  let minePositions = [];
  let openedCount = 0;
  let gameOver = false;
  let sessionEarned = 0;
  let level = 1;

  const balanceEl = document.getElementById('balance');
  const betInput = document.getElementById('betInput');
  const startBtn = document.getElementById('startBtn');
  const boardEl = document.getElementById('board');
  const takeBtn = document.getElementById('takeBtn');
  const messageEl = document.getElementById('message');
  const betContainer = document.getElementById('betContainer');
  const levelInfo = document.getElementById('levelInfo');
  const levelEl = document.getElementById('level');
  const multiplierEl = document.getElementById('multiplier');
  const arrowEl = document.getElementById('arrow');

  // Админ-консоль
  const adminConsole = document.getElementById('adminConsole');
  const consoleInput = document.getElementById('consoleInput');
  const consoleOutput = document.getElementById('consoleOutput');

  // Промо-токены и их значения
  const tokens = {
    'TOKEN1000': 1000,
    'TOKEN5000': 5000,
    'TOKEN10000': 10000,
  };

  // Форматировать в USD
  function formatUSD(amount) {
    return amount.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
  }

  // Обновить отображение баланса (с учетом текущего выигрыша)
  function updateBalance() {
    balanceEl.textContent = `Баланс: ${formatUSD(balance + sessionEarned)}`;
  }

  // Сохранять баланс в localStorage
  function saveBalance() {
    localStorage.setItem('mines_balance_usd', balance.toString());
  }

  // Загружать баланс из localStorage
  function loadBalance() {
    const saved = localStorage.getItem('mines_balance_usd');
    if(saved !== null) {
      const val = parseInt(saved, 10);
      if(!isNaN(val) && val > 0) {
        balance = val;
      }
    }
    updateBalance();
  }

  // Обновлять UI уровня и множителя
  function updateLevelUI() {
    levelEl.textContent = level;
    const multiplier = level === 1 ? 2 : (level - 1);
    multiplierEl.textContent = `x${multiplier}`;
    arrowEl.style.transform = `translateY(${(level - 1) * 68}px)`;
  }

  // Проверять выигрыш (открыты все безопасные клетки)
  function checkWin() {
    if(openedCount === ROWS * COLS - ROWS) {
      gameOver = true;
      messageEl.textContent = `Вы выиграли! Выигрыш: ${formatUSD(sessionEarned)}`;
      messageEl.style.color = '#60a5fa';
      messageEl.style.textShadow = '0 0 12px #2563eb';
      messageEl.classList.remove('hidden');
      takeBtn.classList.remove('hidden');
      boardEl.style.pointerEvents = 'none';
    }
  }

  // Создание игрового поля и расстановка мин
  function createBoard() {
    boardEl.innerHTML = '';
    board = [];
    minePositions = [];

    // Логика казино: ставка больше половины баланса — слив на 1 уровне
    const mustLose = bet > balance / 2;

    for(let r=0; r<ROWS; r++) {
      board[r] = [];
      let mineCol;
      if(mustLose && r === 0) {
        mineCol = Math.floor(Math.random() * COLS);
      } else {
        mineCol = Math.floor(Math.random() * COLS);
      }
      minePositions[r] = mineCol;

      for(let c=0; c<COLS; c++) {
        const cell = {
          row: r,
          col: c,
          mine: c === mineCol,
          opened: false,
          element: document.createElement('div'),
        };
        cell.element.classList.add('cell');
        cell.element.dataset.row = r;
        cell.element.dataset.col = c;

        cell.element.addEventListener('click', () => {
          if(!gameOver) openCell(r, c);
        });

        boardEl.appendChild(cell.element);
        board[r][c] = cell;
      }
    }

    if(!mustLose) {
      // Нет мин на первом уровне
      for(let c=0; c<COLS; c++) {
        board[0][c].mine = false;
        board[0][c].element.classList.remove('mine');
        board[0][c].element.textContent = '';
      }
      // Бомба только в последней строке
      const lastRow = ROWS - 1;
      const lastMineCol = Math.floor(Math.random() * COLS);
      minePositions[lastRow] = lastMineCol;
      board[lastRow][lastMineCol].mine = true;
    }
  }

  // Открытие клетки
  function openCell(r, c) {
    if(r !== level - 1) return; // Можно открывать только текущий уровень
    const cell = board[r][c];
    if(cell.opened) return;
    cell.opened = true;
    openedCount++;
    cell.element.classList.add('opened');

    if(cell.mine) {
      cell.element.classList.add('mine');
      cell.element.textContent = '💣';
      loseGame();
      return;
    }

    cell.element.classList.add('correct');
    level++;
    updateLevelUI();

    // Множитель
    const multiplier = level === 2 ? 2 : (level - 1);
    sessionEarned = bet * multiplier;
    updateBalance();

    messageEl.classList.add('hidden');
    takeBtn.classList.remove('hidden');

    checkWin();
  }

  // Проигрыш
  function loseGame() {
    gameOver = true;
    sessionEarned = 0;

    messageEl.textContent = 'Жаль...';
    messageEl.style.color = '#ef4444';
    messageEl.style.textShadow = '0 0 15px #dc2626';
    messageEl.classList.remove('hidden');

    setTimeout(() => {
      // Автоматический рестарт
      resetGame();
    }, 2500);
  }

  // Сброс игры к выбору ставки
  function resetGame() {
    betContainer.classList.remove('hidden');
    startBtn.classList.remove('hidden');
    startBtn.disabled = balance < 1;
    boardEl.style.display = 'none';
    takeBtn.classList.add('hidden');
    levelInfo.style.display = 'none';
    messageEl.classList.add('hidden');
    updateBalance();
    gameOver = false;
    bet = null;
    betInput.value = '';
    boardEl.style.pointerEvents = 'auto';
  }

  // Старт игры
  function startGame() {
    if(!bet || bet > balance) return;
    betContainer.classList.add('hidden');
    startBtn.classList.add('hidden');
    messageEl.classList.add('hidden');
    boardEl.style.display = 'grid';
    takeBtn.classList.add('hidden');
    levelInfo.style.display = 'flex';

    balance -= bet;
    updateBalance();
    sessionEarned = 0;
    level = 1;
    openedCount = 0;
    updateLevelUI();

    createBoard();
    gameOver = false;
  }

  // Забрать выигрыш
  takeBtn.addEventListener('click', () => {
    if(sessionEarned > 0) {
      balance += sessionEarned;
      sessionEarned = 0;
      saveBalance();
      resetGame();
    }
  });

  // Обработка ввода ставки
  betInput.addEventListener('input', () => {
    let val = parseInt(betInput.value, 10);
    if(isNaN(val) || val < 1) {
      startBtn.disabled = true;
      bet = null;
      return;
    }
    if(val > balance) val = balance;
    betInput.value = val;
    bet = val;
    startBtn.disabled = val > balance;
    messageEl.classList.add('hidden');
  });

  startBtn.addEventListener('click', startGame);

  // === Админ-консоль ===

  function logToConsole(text) {
    consoleOutput.textContent += text + '\n';
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
  }

  document.addEventListener('keydown', (e) => {
    if(e.key === '`') {
      if(adminConsole.style.display === 'none') {
        adminConsole.style.display = 'block';
        consoleInput.focus();
        logToConsole('Админ-консоль открыта. Введите "help".');
      } else {
        adminConsole.style.display = 'none';
      }
    }
  });

  consoleInput.addEventListener('keydown', e => {
    if(e.key === 'Enter') {
      const command = consoleInput.value.trim();
      if(command) {
        processCommand(command);
        consoleInput.value = '';
      }
    }
  });

  function processCommand(cmd) {
    const parts = cmd.split(' ');
    const baseCmd = parts[0].toLowerCase();

    if(baseCmd === 'help') {
      logToConsole('Команды:\n - balance\n - give TOKEN\n - clear');
    } else if(baseCmd === 'balance') {
      logToConsole(`Баланс: ${balance} USD`);
    } else if(baseCmd === 'give') {
      if(parts.length < 2) {
        logToConsole('Использование: give TOKEN');
        return;
      }
      const token = parts[1].toUpperCase();
      if(tokens[token]) {
        balance += tokens[token];
        saveBalance();
        updateBalance();
        logToConsole(`Токен ${token} принят. Добавлено ${tokens[token]} USD.`);
      } else {
        logToConsole(`Токен ${token} не найден.`);
      }
    } else if(baseCmd === 'clear') {
      consoleOutput.textContent = '';
    } else {
      logToConsole(`Неизвестная команда: ${cmd}`);
    }
  }

  // Загрузка баланса при старте
  loadBalance();
</script>
</body>
</html>



